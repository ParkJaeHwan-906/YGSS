pipeline {
  agent any

  environment {
    // ë°°í¬ í™˜ê²½ (infra-refactor â†’ master ë³€ê²½)
    DOCKER_IMAGE  = 'ygss-backend'
    DOCKER_TAG    = "v${BUILD_NUMBER}"          // refactor-${BUILD_NUMBER} â†’ v${BUILD_NUMBER}
    AI_IMAGE      = 'ygss-ai'
    AI_TAG        = "v${BUILD_NUMBER}"          // refactor-${BUILD_NUMBER} â†’ v${BUILD_NUMBER}
    K8S_NAMESPACE = 'ygss-prod'                 // ygss-infra â†’ ygss-prod

    // k3s kubeconfig
    KUBECONFIG = '/etc/rancher/k3s/k3s.yaml'

    // Jenkins Credentials (masterì— GMS_SECRET_KEY ì¶”ê°€)
    MYSQL_PASSWORD = credentials('mysql-password')
    JWT_SECRET     = credentials('jwt-secret')
    GMS_SECRET_KEY = credentials('gms-secret-key')  // infra-refactorì—ëŠ” ì—†ì—ˆìŒ
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '3'))   // infra-refactor: 3 â†’ master: ìœ ì§€
    timeout(time: 20, unit: 'MINUTES')              // infra-refactor: 20ë¶„ â†’ master: ìœ ì§€
    timestamps()
    disableConcurrentBuilds()
  }

  stages {
    stage('ì²´í¬ì•„ì›ƒ') {
      steps {
        echo 'ğŸ”„ ë§ˆìŠ¤í„° ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ'
        git branch: 'master',
            url: 'https://lab.ssafy.com/s13-bigdata-recom-sub1/S13P21A103.git',
            credentialsId: 'gitlab-git-token'

        script {
          env.GIT_COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
        }
        echo "ğŸš€ ë°°í¬ ë¹Œë“œ ì‹œì‘ - ì»¤ë°‹: ${env.GIT_COMMIT}"
      }
    }

    stage('ë¸Œëœì¹˜ ê°€ë“œ') {
      steps {
        script {
          def current = sh(script: "git rev-parse --abbrev-ref HEAD", returnStdout: true).trim()
          if (!current.contains('master')) {
            error "This pipeline runs only on master branch. Current: ${current}"
          }
        }
      }
    }

    stage('ì†ŒìŠ¤ ê²€ì¦') {
      steps {
        sh '''
          set -euo pipefail
          echo "ğŸ” í•„ìˆ˜ íŒŒì¼ í™•ì¸"
          [ -f backend/build.gradle ] || { echo "âŒ backend/build.gradle ì—†ìŒ"; exit 1; }
          [ -f backend/Dockerfile   ] || { echo "âŒ backend/Dockerfile ì—†ìŒ"; exit 1; }
          [ -f ai/Dockerfile ] || { echo "âŒ ai/Dockerfile ì—†ìŒ"; exit 1; }
          [ -f ai/requirements.txt ] || { echo "âŒ ai/requirements.txt ì—†ìŒ"; exit 1; }
          [ -d k8s/base ] && [ -d k8s/overlays/prod ] || { echo "âŒ k8s overlay ì—†ìŒ"; exit 1; }  // infra-refactor â†’ prod
          echo "âœ… í•„ìˆ˜ íŒŒì¼ í™•ì¸ ì™„ë£Œ"
        '''
      }
    }

    stage('kustomize ì„¤ì¹˜ í™•ì¸') {
      steps {
        sh '''
          set -euo pipefail
          if command -v kustomize &> /dev/null; then
            echo "âœ… kustomize ì´ë¯¸ ì„¤ì¹˜ë¨"
          else
            echo "ğŸ“¦ kustomize v5.7.1 ì„¤ì¹˜ ì¤‘..."
            curl -Lo kustomize.tar.gz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v5.7.1/kustomize_v5.7.1_linux_amd64.tar.gz"
            tar -xzf kustomize.tar.gz
            sudo mv kustomize /usr/local/bin/
            sudo chmod +x /usr/local/bin/kustomize
            rm -f kustomize.tar.gz
            echo "âœ… kustomize ì„¤ì¹˜ ì™„ë£Œ"
          fi
        '''
      }
    }

    stage('AI Base Image í™•ì¸') {
      steps {
        script {
          def baseExists = sh(
            script: "docker images | grep ygss-ai-base",
            returnStatus: true
          ) == 0
          
          if (!baseExists) {
            echo "ğŸ¤– AI Base ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            sh "cd ai && docker build -f Dockerfile.base -t ygss-ai-base:latest ."
          } else {
            echo "âœ… AI Base ì´ë¯¸ì§€ ì¬ì‚¬ìš©"
          }
        }
      }
    }

    stage('ë°±ì—”ë“œ ë¹Œë“œ') {
      steps {
        echo 'ğŸ”¨ ë°±ì—”ë“œ ë¹Œë“œ'
        dir('backend') {
          sh '''
            set -euo pipefail
            chmod +x ./gradlew
            ./gradlew clean build -x test --no-daemon
          '''
        }
      }
    }

    stage('AI ì„œë²„ ë¹Œë“œ') {
      steps {
        echo 'ğŸ¤– AI FastAPI ì„œë²„ ë¹Œë“œ'
        dir('ai') {
          sh '''
            set -euo pipefail
            echo "=== AI ë¹Œë“œ ì „ íŒŒì¼ í™•ì¸ ==="
            ls -la src/
            echo "=== Dockerfile í™•ì¸ ==="
            cat Dockerfile
            docker build --no-cache -t $AI_IMAGE:$AI_TAG .
            echo "âœ… AI ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $AI_IMAGE:$AI_TAG"
          '''
        }
      }
    }

    stage('Docker ì´ë¯¸ì§€ ë¹Œë“œ') {
      steps {
        dir('backend') {
          sh '''
            set -euo pipefail
            echo 'ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ'
            docker build -t $DOCKER_IMAGE:$DOCKER_TAG .
            echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $DOCKER_IMAGE:$DOCKER_TAG"
          '''
        }
      }
    }

    stage('k3s(containerd) ì´ë¯¸ì§€ import') {
      steps {
        sh '''
          set -Eeuo pipefail
          echo "ğŸ“¦ Docker â†’ k3s(containerd) import"

          docker save "$DOCKER_IMAGE:$DOCKER_TAG" -o "/tmp/$DOCKER_IMAGE-$DOCKER_TAG.tar"
          sudo -n /usr/local/bin/k3s ctr images import "/tmp/$DOCKER_IMAGE-$DOCKER_TAG.tar"
          rm -f "/tmp/$DOCKER_IMAGE-$DOCKER_TAG.tar"
          echo "âœ… Backend containerd import ì™„ë£Œ"
        '''
      }
    }

    stage('AI ì´ë¯¸ì§€ import') {
      steps {
        sh '''
          set -Eeuo pipefail
          echo "ğŸ“¦ AI Docker â†’ k3s(containerd) import"

          docker save "$AI_IMAGE:$AI_TAG" -o "/tmp/$AI_IMAGE-$AI_TAG.tar"
          sudo -n /usr/local/bin/k3s ctr images import "/tmp/$AI_IMAGE-$AI_TAG.tar"
          rm -f "/tmp/$AI_IMAGE-$AI_TAG.tar"
          echo "âœ… AI containerd import ì™„ë£Œ"
        '''
      }
    }

    stage('K8s Secret ìƒì„±') {
      steps {
        sh '''
          set -euo pipefail
          echo 'ğŸ” Kubernetes Secret ìƒì„±/ì—…ë°ì´íŠ¸'
          kubectl create namespace $K8S_NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

          kubectl -n $K8S_NAMESPACE create secret generic backend-secrets \
            --from-literal=MYSQL_PASSWORD="$MYSQL_PASSWORD" \
            --from-literal=JWT_SECRET="$JWT_SECRET" \
            --from-literal=GMS_SECRET_KEY="$GMS_SECRET_KEY" \
            --dry-run=client -o yaml | kubectl apply -f -

          echo 'âœ… Secret ìƒì„± ì™„ë£Œ'
        '''
      }
    }

    stage('Kustomize ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¤€ë¹„') {
      steps {
        sh '''
          set -euo pipefail
          echo "âš™ï¸ Kustomize ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¤€ë¹„"
          
          cd k8s/overlays/prod
          
          # ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì •
          kustomize edit set image ygss-backend:${DOCKER_TAG}
          kustomize edit set image ygss-ai:${AI_TAG}
          
          # dry-runìœ¼ë¡œ ê²€ì¦
          kustomize build . | kubectl apply --dry-run=client -f -
          echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê²€ì¦ ì™„ë£Œ"
        '''
      }
    }

    stage('Kubernetes ë°°í¬') {
      steps {
        sh '''
          set -euo pipefail
          echo 'ğŸš¢ Kubernetes ë°°í¬'
          
          cd k8s/overlays/prod
          kubectl apply -k .
          kubectl -n $K8S_NAMESPACE rollout status deployment/backend --timeout=300s
          kubectl -n $K8S_NAMESPACE rollout status deployment/ai --timeout=300s

          echo '=== ë¦¬ì†ŒìŠ¤ í˜„í™© ==='
          kubectl -n $K8S_NAMESPACE get all
        '''
      }
    }

    stage('í—¬ìŠ¤ì²´í¬') {
      steps {
        script {
          echo 'â³ Pod ì‹œì‘ ëŒ€ê¸° ì¤‘...'
          sleep(time: 15, unit: 'SECONDS')
          
          echo 'ğŸ¥ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬'
          timeout(time: 3, unit: 'MINUTES') {
            waitUntil {
              def code = sh(
                script: '''
                  curl -s -k -o /dev/null -w "%{http_code}" \
                       --connect-timeout 10 \
                       --max-time 30 \
                       https://j13a103.p.ssafy.io/api/infra || echo 000
                ''',
                returnStdout: true
              ).trim()
              echo "ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬: ${code}"
              return (code == '200')
            }
          }
          
          echo 'ğŸ¤– AI í—¬ìŠ¤ì²´í¬'
          timeout(time: 3, unit: 'MINUTES') {
            waitUntil {
              def aiCode = sh(
                script: '''
                  curl -s -k -o /dev/null -w "%{http_code}" \
                       --connect-timeout 10 \
                       --max-time 30 \
                       https://j13a103.p.ssafy.io/ai/health/ || echo 000
                ''',
                returnStdout: true
              ).trim()
              echo "AI í—¬ìŠ¤ì²´í¬: ${aiCode}"
              return (aiCode == '200')
            }
          }
          
          echo 'âœ… ëª¨ë“  í—¬ìŠ¤ì²´í¬ í†µê³¼!'
        }
      }
    }

    stage('ì´ë¯¸ì§€ ì •ë¦¬') {
      steps {
        sh '''
          set -euo pipefail
          echo 'ğŸ§¹ ì´ë¯¸ì§€ ì •ë¦¬'
          
          # ìµœê·¼ 2ê°œ ë²„ì „ë§Œ ìœ ì§€ (infra-refactorì™€ ë™ì¼)
          KEEP=2
          
          # ë°±ì—”ë“œ ì´ë¯¸ì§€ ì •ë¦¬
          TAGS=$(docker images "$DOCKER_IMAGE" --format '{{.Tag}}' | grep -E '^v[0-9]+' | sort -V -r || true)
          COUNT=0
          for t in $TAGS; do
            COUNT=$((COUNT+1))
            if [ $COUNT -le $KEEP ]; then continue; fi
            docker rmi "$DOCKER_IMAGE:$t" 2>/dev/null || true
          done
          
          # AI ì´ë¯¸ì§€ ì •ë¦¬
          AI_TAGS=$(docker images "$AI_IMAGE" --format '{{.Tag}}' | grep -E '^v[0-9]+' | sort -V -r || true)
          COUNT=0
          for t in $AI_TAGS; do
            COUNT=$((COUNT+1))
            if [ $COUNT -le $KEEP ]; then continue; fi
            docker rmi "$AI_IMAGE:$t" 2>/dev/null || true
          done
          
          docker image prune -f || true
        '''
      }
    }
  }

  post {
    success {
      echo """
âœ… ë°°í¬ ì„±ê³µ!

â€¢ ë¸Œëœì¹˜: master
â€¢ ì»¤ë°‹: ${env.GIT_COMMIT}
â€¢ ë°±ì—”ë“œ: ${env.DOCKER_IMAGE}:${env.DOCKER_TAG}
â€¢ AI: ${env.AI_IMAGE}:${env.AI_TAG}

ğŸ”— í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸:
â€¢ ë°±ì—”ë“œ: https://j13a103.p.ssafy.io/api/infra
â€¢ AI: https://j13a103.p.ssafy.io/ai/health/
"""
    }
    failure {
      echo 'âŒ ë°°í¬ ì‹¤íŒ¨! ë””ë²„ê¹… ì •ë³´'
      sh '''
        set -euo pipefail
        echo '=== Pods ==='
        kubectl -n $K8S_NAMESPACE get pods -o wide || true
        echo '=== ë°±ì—”ë“œ ë¡œê·¸ ==='
        kubectl -n $K8S_NAMESPACE logs -l app=backend --tail=30 || true
        echo '=== AI ë¡œê·¸ ==='
        kubectl -n $K8S_NAMESPACE logs -l app=ai --tail=30 || true
        echo '=== Deployment ìƒíƒœ ==='
        kubectl -n $K8S_NAMESPACE describe deployment backend || true
        kubectl -n $K8S_NAMESPACE describe deployment ai || true
      '''
    }
    always {
      cleanWs()
    }
  }
}